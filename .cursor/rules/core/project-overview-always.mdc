---
description:
globs:
alwaysApply: true
---

# Systematic Review Automation Tool

## Project Identity
- **Purpose:** Automate systematic literature reviews to produce IEEE-submission-ready manuscripts
- **Stack:** Python 3.11+, PydanticAI Graph, SQLite, Google Gemini 2.5, statsmodels, matplotlib
- **Package manager:** uv
- **Architecture:** Typed state, SQLite persistence, 3-tier LLM model selection

## Key Directories
- `src/models/` -- Pydantic data contracts (enums, config, papers, screening, extraction, quality, writing, workflow)
- `src/db/` -- SQLite schema, connection manager, typed repositories
- `src/orchestration/` -- PydanticAI Graph nodes, state, quality gates
- `src/search/` -- OpenAlex, PubMed, arXiv, IEEE connectors + dedup + strategy
- `src/screening/` -- Dual-reviewer screener, prompts, reliability (Cohen's kappa)
- `src/extraction/` -- LLM-powered structured extraction, study classifier
- `src/quality/` -- RoB 2, ROBINS-I, CASP, GRADE, study router
- `src/synthesis/` -- Meta-analysis (statsmodels), effect sizes, narrative fallback
- `src/writing/` -- Section writer, prompts, humanizer, style extractor, naturalness scorer
- `src/citation/` -- Citation ledger, BibTeX generation
- `src/prisma/` -- PRISMA 2020 flow diagram
- `src/visualization/` -- Forest plot, funnel plot, RoB figure, timeline, geographic
- `src/export/` -- IEEE LaTeX, submission packager, PRISMA checklist validator
- `src/llm/` -- PydanticAI agent factory, rate limiter, cost tracking
- `config/` -- review.yaml (per-review) + settings.yaml (system behavior)

## Key Tables
- `workflows` -- topic, config_hash, status for topic-based auto-resume

## Critical Constraints
- **Use `rich`** for CLI output (progress bars, tables, status)
- **Verify APIs** before embedding: use @Ref or Exa to check current docs for statsmodels, pydantic_graph, aiosqlite, etc. Do not embed outdated code patterns.
- **NO untyped dictionaries** at phase boundaries -- only Pydantic models
- **NO LLM-computed statistics** -- meta-analysis uses scipy/statsmodels only
- **ALL I/O is async** (aiosqlite, aiohttp)
- **ALL LLM calls logged** with model, tokens, cost, latency to cost_records table
- **Citation lineage enforced** -- every claim must trace to evidence to citation
- See `config/review.yaml` for per-review topic config, `config/settings.yaml` for agent models + thresholds

<example>
# Good: Typed phase boundary
async def screen_paper(paper: CandidatePaper) -> DualScreeningResult:
    ...
</example>

<example type="invalid">
# Bad: Untyped dictionary crossing phase boundary
async def screen_paper(paper: dict) -> dict:
    ...
</example>
